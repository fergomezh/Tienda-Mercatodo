<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>{{ titulo }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <h1 class="navbar-brand mb-0 text-warning">MercaTodoSv</h1>
        <button
          class="btn btn-warning position-relative"
          data-bs-toggle="modal"
          data-bs-target="#cartModal"
        >
          Carrito
          <span
            *ngIf="cartTotal > 0"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          >
            ${{ cartTotal.toFixed(2) }}
          </span>
        </button>
      </div>
    </nav>

    <div style="margin-top: 80px"></div>

    <!-- Slider -->
    <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img
            src="https://i.ibb.co/PZ45DCFx/mercatodo2.jpg?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
            class="d-block w-100"
            alt="Imagen 1"
            style="height: 650px; object-fit: cover"
          />
        </div>
        <div class="carousel-item">
          <img
            src="https://i.ibb.co/8gVJ17BD/mercatodo1.jpg?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D0"
            class="d-block w-100"
            alt="Imagen 2"
            style="height: 650px; object-fit: cover"
          />
        </div>
        <div class="carousel-item">
          <img
            src="https://i.ibb.co/ksPLbFQn/mercatodo3.jpg?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
            class="d-block w-100"
            alt="Imagen 3"
            style="height: 650px; object-fit: cover"
          />
        </div>
      </div>
      <button
        class="carousel-control-prev"
        type="button"
        data-bs-target="#carouselExample"
        data-bs-slide="prev"
      >
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button
        class="carousel-control-next"
        type="button"
        data-bs-target="#carouselExample"
        data-bs-slide="next"
      >
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>

    <div class="container my-5">
      <!-- Filtros -->
      <div class="card mb-4">
        <div class="card-body">
          <h5>
            Productos de la categoría:
            <strong>{{
              selectedCategory === "all" ? "Todos" : selectedCategory
            }}</strong>
          </h5>
          <div class="row g-3 align-items-center">
            <div class="col-md-6">
              <input
                type="text"
                class="form-control"
                placeholder="Buscar producto..."
                [(ngModel)]="searchText"
                (input)="applySearchFilter()"
              />
            </div>
            <div class="col-md-4">
              <select
                class="form-select"
                [(ngModel)]="selectedCategory"
                (change)="filterByCategory()"
              >
                <option value="all">Todas las categorías</option>
                <option *ngFor="let cat of categories" [value]="cat">
                  {{ cat }}
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Productos -->
      <div class="row row-cols-1 row-cols-md-4 g-4">
        <div class="col" *ngFor="let product of filteredProducts">
          <div class="card h-100 shadow-sm">
            <img
              [src]="product.image"
              class="card-img-top p-3"
              style="height: 200px; object-fit: contain"
              [alt]="product.title"
            />
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">
                {{ product.title | slice : 0 : 50 }}...
              </h6>
              <p class="text-success fw-bold fs-4">${{ product.price }}</p>
              <button
                class="btn btn-outline-primary mt-auto"
                data-bs-toggle="modal"
                [attr.data-bs-target]="'#productModal-' + product.id"
              >
                Detalles
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Detalle Producto -->
    <div
      *ngFor="let product of products"
      class="modal fade"
      [id]="'productModal-' + product.id"
      tabindex="-1"
      role="dialog"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ product.title }}</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5">
                <img
                  [src]="product.image"
                  class="img-fluid"
                  [alt]="product.title"
                />
              </div>
              <div class="col-md-7">
                <p><strong>Precio:</strong> ${{ product.price }}</p>
                <p><strong>Categoría:</strong> {{ product.category }}</p>
                <p><strong>Descripción:</strong> {{ product.description }}</p>
                <p>
                  <strong>Valoración:</strong> {{ product.rating.rate }} / 5 ({{
                    product.rating.count
                  }}
                  opiniones)
                </p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-success"
              (click)="addToCart(product); $event.stopPropagation()"
            >
              Agregar al carrito
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Carrito (con fixes para accesibilidad) -->
    <div class="modal fade" id="cartModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Carrito de Compra</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div *ngIf="cart.length === 0" class="text-center py-5">
              <h4>Tu carrito está vacío</h4>
              <p>¡Agrega algunos productos para empezar a comprar!</p>
            </div>
            <div *ngIf="cart.length > 0">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acción</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of cart">
                    <td>{{ item.product.title | slice : 0 : 40 }}...</td>
                    <td>${{ item.product.price.toFixed(2) }}</td>
                    <td>
                      <button
                        class="btn btn-sm btn-outline-secondary me-1"
                        (click)="updateQuantity(item, -1)"
                      >
                        -
                      </button>
                      <span class="badge bg-light text-dark px-2">{{
                        item.quantity
                      }}</span>
                      <button
                        class="btn btn-sm btn-outline-secondary ms-1"
                        (click)="updateQuantity(item, 1)"
                      >
                        +
                      </button>
                    </td>
                    <td>
                      ${{ (item.product.price * item.quantity).toFixed(2) }}
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-danger"
                        (click)="removeFromCart(item.product.id)"
                      >
                        Eliminar
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="d-flex justify-content-end mt-3">
                <h4 class="text-success">Total: ${{ cartTotal.toFixed(2) }}</h4>
              </div>
            </div>
          </div>
          <div class="modal-footer" *ngIf="cart.length > 0">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
            <button
              type="button"
              class="btn btn-success btn-lg"
              (click)="pay()"
            >
              Pagar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
